<!DOCTYPE html>
<html>
    <head>
        <title>Bedrock Server Manager: Micah Henney</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();
            var loginUsername;
            var loginPassword;
            var servers = [];
            window.onload = () => {
                socket.on('connect', () => {
                    console.log("Connected!");
                });
                loginUsername = document.getElementById("login:username");
                loginPassword = document.getElementById("login:password");
                var serverbox = document.getElementById('servers');
                socket.on('loginResult', data => {
                    if(!data.success) {
                        console.log("No success :(");
                        return;
                    }
                    // console.log("Logged in!");
                    // console.log(data);
                    document.getElementById('login').classList.add("hidden");
                    const serversele = document.getElementById("servers");
                    serversele.classList.remove("hidden");
                    socket.emit("getServers");
                    socket.on("serverList", (acceptedServers) => {
                        // console.log(servers);
                        acceptedServers.forEach(server => {
                            const skeletonBegin = `<tr class="server-row"><td><table id="serverlistid${server.id}" class="listblack serverlist mc-font">
                    <tbody>
                        <tr>
                            <td class="server-cell fill-space"><span style="color: white; font-size: 1em;">${server.name}</h3></td>
            
                            <td class="server-cell right-align">${server.version}</td>
                            <td class="server-cell right-align min-cell-size ${server.status === "Started" ? 'green' : server.status === "Stopped" ? 'red' : 'yellow'}">${server.status}</td>
                        </tr>
                        <tr>
                            <td class="server-cell">${server.port}</td>
                            <td class="server-cell right-align" style="white-space: nowrap;">${server.onlinePlayers}/${server.maxPlayers} online</td>
                            <td class="server-cell right-align min-cell-size">${server.status === "Started" ? '<img class="status-light" src="Green light.png">' : '<img class="status-light" src="Red light.png">'}</td>
                        </td></tr>
                    </tbody>
                </table></td> 
            </tr>`;
                            serverbox.children[0].innerHTML += skeletonBegin;
                            // console.log("Adding event listener! " + document.getElementById('serverlistid'+server.id).id);
                            // Use a delay to let the document changes apply
                            setTimeout(() => document.getElementById('serverlistid' + server.id).addEventListener('click', data => serverClicked(server.id, data)), 1);
                        });
                        servers = new Map(acceptedServers.map(server => {
                            server.isCached = false;
                            return [server.id, server];
                        }));
                        document.getElementById('loginFinished').classList.remove("hidden");
                    });
                })
                document.getElementById('login').addEventListener("submit", handleLoginSubmitted, false);
                const tabsU = [...document.querySelectorAll(".serverdata > .header > .tab")];
                const serverdatatabsmap = new Map(tabsU.map(element => [element, element.dataset.hash]));
                serverdatatabs = new TabGroup(serverdatatabsmap, document.getElementById('serverdatatab1'));
            };
            function handleLoginSubmitted(e) {
                // console.log("Submitted");
                socket.emit("login", { username: loginUsername.value, password: loginPassword.value });
                e.preventDefault();
            };
            function serverClicked(id, data) {
                // console.log(`Id: ${id}`);
                // console.log(`Data: ${JSON.stringify(data)}`);
                if(selectedServer)
                    selectedServer.classList.remove('selected');
                // [...document.getElementsByClassName('serverlist')].forEach(item => item.classList.remove('selected'));
                let item = document.getElementById('serverlistid' + id);
                selectedServer = item;
                item.classList.add('selected');
                refreshData(id);
            }
            var selectedServer;

            class TabGroup {
                constructor(tabs, active) {
                    this.tabs = tabs;
                    if(active) {
                        this.selectTab(active);
                        this.active = active;
                    }
                    [...this.tabs.keys()].forEach(tab => {
                        tab.onclick = () => {
                            this.selectTab(tab);
                            // location.hash = tabs.get(tab);
                        };
                    });
                }
                selectTab(tab) {
                    if(this.active) {
                        document.getElementById("tabcontent-" + this.tabs.get(this.active)).classList.remove('selected');
                        this.active.classList.remove("selected");
                    }
                    tab.classList.add("selected");
                    this.active = tab;
                    document.getElementById("tabcontent-" + this.tabs.get(tab)).classList.add('selected');
                }
            }
            var serverdatatabs;
        </script>
    <script src="client.js"></script>

        <form id="login" action="">
            <input type="text" name="username" id="login:username">
            <input type="password" name="password" id="login:password">
            <input type="submit" name="login:submit" value="Submit"><!--onclick="handleLoginSubmitted()"-->
        </form>
        <div id="loginFinished" class="hidden">
            <table class="fullpage" id="id000">
                <tbody class="fullpage">
                    <tr class="fullpage">
                        <td class="fullpage serverside">
                            <div id="serverzone">
                                <div class="tab selected">
                                    <span class="mc-font tabtext">Servers</h3>
                                </div>
                                <div class="styleset-01-positioning">
                                    <div class="styleset-02-borderedges">
                                        <div class="styleset-03-bordersolid">
                                            <div class="styleset-04-scrolling">
                                                <table id="servers">
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="fullpage">
                            <div class="serverdata">
                                <div class="header">
                                    <div id="serverdatatab1" class="tab" data-hash="info"><span class="tabtext">Info</span></div>
                                    <div class="tab" data-hash="permissions"><span class="tabtext">Permissions</span></div>
                                    <div class="tab" data-hash="tab3"><span class="tabtext">Tab 3</span></div>
                                </div>
                                <div class="styleset-01-positioning">
                                    <div class="styleset-02-borderedges">
                                        <div class="styleset-03-bordersolid">
                                            <div class="styleset-04-scrolling">
                                                <div id="tabcontent-info" class="tabcontent">
                                                    <h3>Server Info</h3>
                                                    <table id="infotable">
                                                        <tbody>
                                                            <tr>
                                                                <td>Name:</td>
                                                                <td><span id="infotablename"><span style="color: red;">No server selected</span></span></td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="2">
                                                                    <!-- <br> -->
                                                                    Description:
                                                                    <p id="infotabledesc" class="description"></p>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>Status:</td>
                                                                <td><span id="infotablestatus"></span></td>
                                                                <td class="editbutton"><img src="pencil.png" alt="edit"></td>
                                                            </tr>
                                                            <tr>
                                                                <td>Players Online:</td>
                                                                <td><span id="infotableplayersonline">0</span>/<span id="infotablemaxplayers">0</span></td>
                                                            </tr>
                                                            <tr>
                                                                <td>Port:</td>
                                                                <td><span id="infotableport"></span></td>
                                                            </tr>
                                                            <tr>
                                                                <td>Version:</td>
                                                                <td><span id="infotableversion"></span></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    <div class="apply propeditavailible">
                                                        <button>Apply</button>
                                                        <button class="red">Revert</button>
                                                    </div>
                                                </div>
                                                <div id="tabcontent-permissions" class="tabcontent">
                                                    <h3>Your Permissions</h3>
                                                    <ul id="permsself">
                                                        <li>Loading</li>
                                                    </ul>
                                                    <div id="permeditavailible" class="hidden">
                                                        <div class="divider"></div>
                                                        <div id="permeditor">
                                                            <table id="permuserlist">
                                                                <tbody>
                                                                    <tr class="server-row listwhite"><td>
                                                                        <div class="listcontent"><div class="dark">Micah</div><div>Creator</div></div>
                                                                    </td></tr>
                                                                    <tr class="server-row listwhite"><td>
                                                                        <div class="listcontent"><div class="dark">Ian</div><div>Admin</div></div>
                                                                    </td></tr>
                                                                </tbody>
                                                            </table>
                                                            <div class="vertdivider"></div>
                                                            <div id="permlist">
                                                                <label class="switch">
                                                                    <input type="checkbox" id="num1">
                                                                    <span class="switchinternal">
                                                                        <span class="switchtab">
                                                                            <span class="switchtabborder"></span>
                                                                        </span>
                                                                        <span class="switchdash"></span>
                                                                    </span>
                                                                    <span class="switchtext">
                                                                        Num1
                                                                    </span>
                                                                </label>
                                                                <label class="switch">
                                                                    <input type="checkbox" id="num2">
                                                                    <span class="switchinternal">
                                                                        <span class="switchtab">
                                                                            <span class="switchtabborder"></span>
                                                                        </span>
                                                                        <span class="switchdash"></span>
                                                                    </span>
                                                                    <span class="switchtext">
                                                                        Num2
                                                                    </span>
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="apply">
                                                            <button>Apply</button>
                                                            <button class="red">Revert</button>
                                                        </div>
                                                    </div>
                                                    </div>
                                                <div id="tabcontent-tab3" class="tabcontent">Tab3</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </body>
</html>